<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>동물달리기 – 커피내기</title>
  <style>
    :root{
      --bg:#0b1020; --panel:#111735; --ink:#eaf2ff; --muted:#9fb2d9; --brand:#5aa1ff; --accent:#8bffb0;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Apple SD Gothic Neo,Malgun Gothic,sans-serif;background:radial-gradient(1200px 600px at 10% -10%, #1a2455, transparent),radial-gradient(1000px 500px at 110% -20%, #123, transparent),var(--bg);color:var(--ink)}
    .wrap{max-width:1100px;margin:24px auto;padding:16px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
    h1{font-size:20px;margin:0;letter-spacing:.3px}
    .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .btn{background:#1a275e;color:#fff;border:1px solid #26408b;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:700}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .select{appearance:none;background:#1a275e;color:#fff;border:1px solid #26408b;padding:10px 12px;border-radius:12px}

    .track{background:linear-gradient(180deg, #10162f, #0d1430);border:1px solid #2a3a7a;border-radius:16px;padding:12px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .lanes{display:grid;gap:10px}
    .lane{display:grid;grid-template-columns:64px 1fr;gap:12px;align-items:center;background:#0f1636;border:1px solid #22306b;border-radius:14px;padding:10px;position:relative}
    .avatar{width:52px;height:52px;border-radius:50%;background:#0d1230;border:2px solid #2c3f88;display:grid;place-items:center;font-size:28px;cursor:pointer;user-select:none;overflow:hidden}
    .avatar img{width:100%;height:100%;object-fit:cover}
    .name{font-size:12px;color:var(--muted);text-align:center;margin-top:6px}
    .progress{height:18px;background:#0a0f28;border:1px solid #202d61;border-radius:999px;overflow:hidden}
    .bar{height:100%;width:0%;background:linear-gradient(90deg, var(--brand), var(--accent));box-shadow:0 0 14px rgba(90,161,255,.6) inset;transition:width .12s ease}

    footer{margin-top:14px;color:var(--muted);font-size:13px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:8px;margin-top:10px}
    .card{background:#0f1738;border:1px solid #23306a;border-radius:12px;padding:10px}
    .hint{color:#bcd1ff;font-size:12px}
    .toast{position:fixed;inset:auto 12px 12px auto;background:#1a275f;border:1px solid #2e4bb5;color:#fff;padding:12px 14px;border-radius:12px;font-weight:700;box-shadow:0 8px 30px rgba(0,0,0,.4);display:none}
    .flag{position:absolute;right:10px;top:10px;background:#1c2c64;border:1px solid #3550b9;color:#e7f0ff;font-size:11px;padding:5px 8px;border-radius:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>🐾 동물달리기 – 커피내기</h1>
      <div class="controls">
        <label>인원
          <select id="count" class="select" aria-label="참가자 수">
            <option>2</option><option selected>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option>
          </select>
        </label>
        <button id="start" class="btn">🏁 시작</button>
        <button id="reset" class="btn" disabled>🔄 리셋</button>
        <button id="shuffle" class="btn">🔀 이모지 섞기</button>
      </div>
    </header>

    <section class="track">
      <div id="lanes" class="lanes"></div>
    </section>

    <footer>
      <div class="grid">
        <div class="card">
          <strong>사용법</strong>
          <div class="hint">아바타를 클릭해 사진을 넣을 수 있어요. 시작을 누르면 6–12초 사이 랜덤 속도로 질주합니다. 1등이 뜨면 자동 정지!</div>
        </div>
        <div class="card">
          <strong>팁</strong>
          <div class="hint">참가자 이름은 아바타 아래 텍스트를 더블클릭해 수정하세요. (엔터로 확정)</div>
        </div>
      </div>
    </footer>
  </div>

  <div id="toast" class="toast"></div>

  <input id="file" type="file" accept="image/*" hidden />

  <script>
  // ------- 설정 -------
  const DEFAULT_EMOJIS = ['🐶','🐱','🐭','🐹','🐰','🦊','🐻','🐼','🐨','🐯','🦁','🐮','🐷','🐸','🐵'];

  // ------- 상태 -------
  let racers = []; // { id, emoji, name, progress, avatarSrc }
  let running = false;
  let raf; // animation frame id
  let startTime, durations = new Map(); // ms per racer
  let activeAvatarIdx = null; // for file input

  // ------- DOM -------
  const $lanes = document.getElementById('lanes');
  const $count = document.getElementById('count');
  const $start = document.getElementById('start');
  const $reset = document.getElementById('reset');
  const $shuffle = document.getElementById('shuffle');
  const $file = document.getElementById('file');
  const $toast = document.getElementById('toast');

  function toast(msg){
    $toast.textContent = msg; $toast.style.display = 'block';
    setTimeout(()=> $toast.style.display='none', 2200);
  }

  function randomSample(arr,n){
    const a=[...arr]; for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]}
    return a.slice(0,n);
  }

  function makeRacers(n){
    const emojis = randomSample(DEFAULT_EMOJIS, n);
    racers = Array.from({length:n}, (_,i)=>({
      id: i,
      emoji: emojis[i],
      name: `참가자 ${i+1}`,
      progress: 0,
      avatarSrc: null
    }));
  }

  function render(){
    $lanes.innerHTML = '';
    $lanes.style.gridTemplateRows = `repeat(${racers.length}, 1fr)`;
    racers.forEach((r,i)=>{
      const lane = document.createElement('div');
      lane.className = 'lane';

      const left = document.createElement('div');
      left.style.textAlign = 'center';

      const avatar = document.createElement('div');
      avatar.className = 'avatar';
      avatar.title = '클릭하여 사진 넣기';
      avatar.addEventListener('click',()=>{ activeAvatarIdx = i; $file.click(); });

      if(r.avatarSrc){
        const img = document.createElement('img'); img.src = r.avatarSrc; avatar.appendChild(img);
      } else {
        avatar.textContent = r.emoji;
      }

      const name = document.createElement('div');
      name.className = 'name';
      name.contentEditable = true; name.spellcheck = false; name.textContent = r.name;
      name.addEventListener('blur',()=> r.name = name.textContent.trim() || r.name);
      name.addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); name.blur(); }});

      left.appendChild(avatar);
      left.appendChild(name);

      const progress = document.createElement('div');
      progress.className = 'progress';
      const bar = document.createElement('div'); bar.className = 'bar'; bar.style.width = r.progress+'%';
      progress.appendChild(bar);

      const flag = document.createElement('div'); flag.className='flag'; flag.textContent = '🏁 결승선';

      lane.appendChild(left);
      lane.appendChild(progress);
      lane.appendChild(flag);
      $lanes.appendChild(lane);
    });
  }

  function reset(){
    running = false; cancelAnimationFrame(raf);
    racers.forEach(r=> r.progress = 0);
    $start.disabled = false; $reset.disabled = true;
    render();
  }

  function start(){
    if(running) return; running = true;
    $start.disabled = true; $reset.disabled = false;
    startTime = performance.now();
    durations.clear();
    // 각 주자 완주 시간: 6~12초 랜덤 (조금의 가중치)
    racers.forEach(r=>{
      const base = 6000 + Math.random()*6000; // 6~12s
      const jitter = (Math.random()-.5)*800; // ±0.4s
      durations.set(r.id, base + jitter);
    });

    function tick(now){
      const elapsed = now - startTime;
      let finished = false;
      racers.forEach(r=>{
        const d = durations.get(r.id);
        const p = Math.min(100, (elapsed/d)*100);
        // 살짝 흔들리는 가속/감속
        const wobble = 0.5*Math.sin((elapsed/250)+(r.id*0.7));
        r.progress = Math.max(0, Math.min(100, p + wobble));
        if(r.progress>=100) finished = true;
      });
      renderBars();
      if(finished){ running = false; announceWinner(); return; }
      raf = requestAnimationFrame(tick);
    }
    raf = requestAnimationFrame(tick);
  }

  function renderBars(){
    document.querySelectorAll('.lane').forEach((lane,idx)=>{
      const bar = lane.querySelector('.bar');
      bar.style.width = racers[idx].progress + '%';
    });
  }

  function announceWinner(){
    // 동률이 생기면 가장 빨리 100에 도달한 인덱스를 우선
    const max = Math.max(...racers.map(r=> r.progress));
    const candidates = racers.map((r,i)=>({i,p:r.progress})).filter(o=> o.p>=max-0.001);
    const winnerIndex = candidates[0].i;
    const w = racers[winnerIndex];
    toast(`🏆 1등: ${w.name}! 커피 면제!`);
  }

  // 파일 업로드 처리 (로컬 미리보기, 서버 업로드 없이 동작)
  $file.addEventListener('change', (e)=>{
    const file = e.target.files?.[0]; if(!file || activeAvatarIdx==null) return;
    const reader = new FileReader();
    reader.onload = ()=>{ racers[activeAvatarIdx].avatarSrc = reader.result; render(); activeAvatarIdx = null; $file.value=''; };
    reader.readAsDataURL(file);
  });

  // 이벤트 바인딩
  $count.addEventListener('change', ()=>{ makeRacers(parseInt($count.value,10)); reset(); });
  $start.addEventListener('click', start);
  $reset.addEventListener('click', reset);
  $shuffle.addEventListener('click', ()=>{ racers.forEach((r,i)=> r.emoji = DEFAULT_EMOJIS[(Math.random()*DEFAULT_EMOJIS.length)|0]); render(); });

  // 초기화
  makeRacers(parseInt($count.value,10));
  render();
  </script>
</body>
</html>
