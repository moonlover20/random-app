<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>동물달리기 – 커피내기 (미니멀 + 사운드)</title>
  <style>
    :root{
      --bg:#0e1218; --ink:#eaf2ff; --muted:#9fb2d9; --edge:#2b323d; --lane:#141a22;
      --glow: 0 0 25px rgba(255,255,255,.25), 0 0 50px rgba(255,255,255,.07);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Apple SD Gothic Neo,Malgun Gothic,sans-serif;background:var(--bg);color:var(--ink);overflow:hidden}

    /* STAGE */
    .stage{position:relative;width:100vw;height:100vh}

    /* HUD */
    .hud{position:absolute;left:0;right:0;display:flex;justify-content:center;gap:16px;pointer-events:auto;user-select:none}
    .hud.top{top:18px}
    .hud.bottom{bottom:18px}
    .chip{display:flex;align-items:center;gap:14px;background:#151b24;border:1px solid var(--edge);border-radius:14px;padding:8px 14px;font-weight:700;opacity:.9}
    .chip b{font-size:14px;letter-spacing:.5px;opacity:.7}
    .chip .val{min-width:56px;text-align:center;font-feature-settings:"tnum" 1;}
    .btn{display:grid;place-items:center;width:28px;height:28px;border-radius:8px;border:1px solid var(--edge);background:#0f141b;cursor:pointer;font-weight:900}

    /* START button */
    .start{position:absolute;inset:0;display:grid;place-items:center;pointer-events:auto}
    .start button{font-size:44px;letter-spacing:2px;border:1px solid var(--edge);background:rgba(255,255,255,.02);color:#fff;border-radius:18px;padding:18px 40px;cursor:pointer;box-shadow:var(--glow)}
    .start button:disabled{opacity:.5;cursor:not-allowed}

    /* LEFT STACK (runners) */
    .stack{position:absolute;left:5vw;top:50%;transform:translateY(-50%);display:flex;flex-direction:column;gap:22px;align-items:flex-start}
    .lane{position:relative;width:90vw;height:72px;background:linear-gradient(90deg, #121820, #0f141b);border:1px solid var(--edge);border-radius:16px}
    .runner{position:absolute;left:10px;top:50%;transform:translate(0,-50%);width:60px;height:60px;border-radius:50%;display:grid;place-items:center;font-size:34px;background:#0f141b;border:1px solid var(--edge);overflow:hidden;transition:filter .2s}
    .runner img{width:100%;height:100%;object-fit:cover}
    .place{position:absolute;left:-10px;top:-10px;width:26px;height:26px;border-radius:999px;background:#ffd166;color:#1a1a1a;border:2px solid #e0a300;display:grid;place-items:center;font-weight:900;font-size:12px}
    .flag{position:absolute;right:10px;top:50%;transform:translateY(-50%);font-size:18px;opacity:.6}

    .hint{position:absolute;left:18px;bottom:18px;color:var(--muted);font-size:12px;opacity:.8}
  </style>
</head>
<body>
  <div class="stage">
    <!-- HUD (Top: duration) -->
    <div class="hud top">
      <div class="chip">
        <b>시간</b>
        <div id="tMinus" class="btn">−</div>
        <div id="tVal" class="val">10s</div>
        <div id="tPlus" class="btn">＋</div>
      </div>
    </div>

    <!-- HUD (Bottom: players) -->
    <div class="hud bottom">
      <div class="chip">
        <b>인원</b>
        <div id="pMinus" class="btn">−</div>
        <div id="pVal" class="val">5p</div>
        <div id="pPlus" class="btn">＋</div>
      </div>
    </div>

    <!-- START overlay -->
    <div class="start"><button id="startBtn">Start</button></div>

    <!-- Runners stack -->
    <div id="stack" class="stack"></div>

    <div class="hint">아바타 클릭으로 사진 변경 · 모든 주자가 결승선에 도달할 때까지 진행</div>
  </div>

  <!-- 🔊 사운드 리소스 (같은 폴더에 start.mp3, finish.mp3 두거나 CDN 사용) -->
  <audio id="sndStart" src="start.mp3" preload="auto"></audio>
  <audio id="sndFinish" src="finish.mp3" preload="auto"></audio>

  <input id="file" type="file" accept="image/*" hidden />

  <script>
  // ===== State =====
  const EMOJIS = ['🐢','🐰','🐷','🐯','🦎','🐶','🦊','🐼','🐨'];
  let players = 5;            // 2..9
  let totalSec = 10;          // 6..20
  let racers = [];            // {id, emoji, x(0..1), avatarSrc, finishedAt, place}
  const durations = new Map();// ms per racer
  let running = false; let raf; let startTime; let nextPlace = 1; let activeIdx = null;

  // ===== DOM =====
  const $stack = document.getElementById('stack');
  const $start = document.getElementById('startBtn');
  const $tMinus = document.getElementById('tMinus');
  const $tPlus = document.getElementById('tPlus');
  const $tVal = document.getElementById('tVal');
  const $pMinus = document.getElementById('pMinus');
  const $pPlus = document.getElementById('pPlus');
  const $pVal = document.getElementById('pVal');
  const $file = document.getElementById('file');
  const $sndStart = document.getElementById('sndStart');
  const $sndFinish = document.getElementById('sndFinish');

  // ===== Utils =====
  const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
  const sample=(arr,n)=>{const a=[...arr];for(let i=a.length-1;i>0;i--){const j=(Math.random()*(i+1))|0;[a[i],a[j]]=[a[j],a[i]];}return a.slice(0,n)}
  const play=(audio)=>{ try{ const a=audio.cloneNode(); a.volume=0.9; a.play(); }catch(e){} } // 빠르게 연속 재생 가능하게 복제

  // ===== Renders =====
  function makeRacers(){
    const pick = sample(EMOJIS, Math.min(players, EMOJIS.length));
    racers = Array.from({length:players}, (_,i)=>({id:i, emoji: pick[i % pick.length], x:0, avatarSrc:null, finishedAt:null, place:null}));
  }

  function renderStack(){
    $stack.innerHTML='';
    for(const r of racers){
      const lane = document.createElement('div'); lane.className='lane';
      const runner = document.createElement('div'); runner.className='runner'; runner.dataset.idx=r.id;
      runner.addEventListener('click',()=>{activeIdx=r.id; $file.click();});
      if(r.avatarSrc){ const img=document.createElement('img'); img.src=r.avatarSrc; runner.appendChild(img)} else runner.textContent=r.emoji;
      const flag = document.createElement('div'); flag.className='flag'; flag.textContent='🏁';
      lane.appendChild(runner); lane.appendChild(flag); $stack.appendChild(lane);
      // set initial position
      requestAnimationFrame(()=>{
        const dist = lane.clientWidth - runner.clientWidth - 24; // padding
        runner.style.transform = `translate(${r.x*dist}px,-50%)`;
      });
    }
  }

  function reset(){
    running=false; cancelAnimationFrame(raf);
    racers.forEach(r=>{r.x=0; r.finishedAt=null; r.place=null;});
    nextPlace=1; $start.textContent='Start'; $start.disabled=false; renderStack();
  }

  function start(){
    if(running) return; running=true; $start.disabled=true; startTime=performance.now(); durations.clear(); nextPlace=1;

    // 🔊 출발 사운드 (사용자 클릭 제스처 직후라 브라우저 정책 허용)
    $sndStart.currentTime = 0; play($sndStart);

    // per-racer finish time with jitter around totalSec
    racers.forEach(r=>{ const base=totalSec*1000; const jitter=(Math.random()-.5)*base*0.5; durations.set(r.id, base + jitter); });

    function tick(now){
      let allFinished=true;
      document.querySelectorAll('.lane').forEach((lane,i)=>{
        const r=racers[i]; const runner=lane.querySelector('.runner');
        const dist = lane.clientWidth - runner.clientWidth - 24;
        if(r.finishedAt==null){
          const elapsed=now-startTime; const dur=durations.get(r.id);
          const baseP=elapsed/dur; const wobble=0.02*Math.sin((elapsed/220)+(i*0.9)); const sprint=0.01*(Math.random()-.5);
          r.x=clamp(baseP+wobble+sprint,0,1);
          if(r.x>=1){
            r.x=1; r.finishedAt=now; r.place=nextPlace++;
            const badge=document.createElement('div'); badge.className='place'; badge.textContent=r.place; runner.appendChild(badge); runner.style.filter='brightness(1.1)';
            // 🔊 각 주자 골인 사운드
            play($sndFinish);
          }
        }
        runner.style.transform=`translate(${r.x*dist}px,-50%)`;
        if(r.finishedAt==null) allFinished=false;
      });
      if(allFinished){ running=false; $start.textContent='Reset'; $start.disabled=false; return; }
      raf=requestAnimationFrame(tick);
    }
    raf=requestAnimationFrame(tick);
  }

  // ===== Events =====
  $start.addEventListener('click',()=>{ if(running) return; if(racers.every(r=>r.finishedAt!=null)) { reset(); } else { start(); } });
  $tMinus.addEventListener('click',()=>{ totalSec=clamp(totalSec-1,6,20); $tVal.textContent=totalSec+'s'; });
  $tPlus.addEventListener('click',()=>{ totalSec=clamp(totalSec+1,6,20); $tVal.textContent=totalSec+'s'; });
  $pMinus.addEventListener('click',()=>{ players=clamp(players-1,2,9); $pVal.textContent=players+'p'; makeRacers(); reset(); });
  $pPlus.addEventListener('click',()=>{ players=clamp(players+1,2,9); $pVal.textContent=players+'p'; makeRacers(); reset(); });

  $file.addEventListener('change', (e)=>{
    const f=e.target.files?.[0]; if(!f || activeIdx==null) return; const reader=new FileReader();
    reader.onload=()=>{ const r=racers.find(x=>x.id===activeIdx); r.avatarSrc=reader.result; activeIdx=null; $file.value=''; renderStack(); };
    reader.readAsDataURL(f);
  });

  // ===== Boot =====
  makeRacers(); renderStack();
  </script>
</body>
</html>
